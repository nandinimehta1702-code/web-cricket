<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cricket Arcade</title>

  <!-- Phaser 3 -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>

  <style>
    :root { --bg:#0b1220; --panel:#0f172a; --line:#334155; --grass:#0a0f1a; --text:#e6edf6; }
    * { box-sizing:border-box; }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif; }
    .topbar {
      position:sticky; top:0; z-index:5;
      display:flex; gap:10px; align-items:center; padding:10px 14px;
      background:linear-gradient(180deg, #0b1220, #0b1220aa 70%, transparent);
    }
    .btn, .sel {
      background:#111827; border:1px solid #293241; color:var(--text);
      border-radius:10px; padding:8px 12px; cursor:pointer; font-size:14px;
    }
    .sel { padding:7px 10px; }
    .hud { padding:0 14px 8px; font-size:14px; color:#9fbba6 }
    #game { display:flex; align-items:center; justify-content:center; height:calc(100vh - 94px); }
    .help { text-align:center; font-size:12px; color:#9aa4b2; padding:10px 0 14px; }
  </style>
</head>
<body>
  <!-- Simple header -->
  <div class="topbar">
    <select class="sel" id="oversSel">
      <option value="1">1 over</option>
      <option value="2" selected>2 overs</option>
      <option value="3">3 overs</option>
      <option value="5">5 overs</option>
    </select>
    <button class="btn" id="newGameBtn">New Game</button>
    <button class="btn" id="choose-player-btn">Choose Player</button>
  </div>

  <div class="hud" id="hud">Score: 0/0 • Overs: 0.0 • Balls left: 12</div>
  <div id="game"></div>
  <div class="help">← / → (or A / D) to move • SPACE or Tap to swing</div>

  <script>
  (() => {
    const W = 1100, H = 620;                    // canvas size
    const LANE_Y = H * 0.62;                    // popping-crease line
    const OUTFIELD_Y = H * 0.78;
    const PITCH_XL = 180;                       // left/right bounds for batter
    const PITCH_XR = W - 180;

    const POP = {
      ballSpeed: 300,
      spawnEveryMs: 1600,
      batCooldownMs: 520,
      playerSpeed: 360,
      overBalls: 6
    };

    // mini score (just for the HUD for now)
    const score = { runs:0, wkts:0, balls:0, overs:2 };
    const updateHUD = () => {
      const overText = `${Math.floor(score.balls/6)}.${score.balls%6}`;
      const left = (score.overs*POP.overBalls) - score.balls;
      document.getElementById('hud').textContent =
        `Score: ${score.runs}/${score.wkts} • Overs: ${overText} • Balls left: ${left}`;
    };

    // stored avatar: 'boy' | 'girl'
    const avatarKey = localStorage.getItem('avatar') === 'girl' ? 'batterGirl' : 'batterBoy';

    class Main extends Phaser.Scene {
      constructor(){ super('main'); }
      preload() {
        // use your fixed paths (these MUST exist)
        this.load.image('batterBoy', '/static/game/assets/batter_boy.png');
        this.load.image('batterGirl','/static/game/assets/batter_girl.png');
        this.load.image('bowler',    '/static/game/assets/bowler.png');
        this.load.image('bat',       '/static/game/assets/bat.png');
        this.load.image('ball',      '/static/game/assets/ball.png');
      }

      create() {
        // backdrop
        this.add.rectangle(W/2, H/2, W, H, 0x0f172a);                 // stage bg
        this.add.rectangle(W/2, LANE_Y, W*0.86, 8, 0x334155);         // crease line
        this.add.rectangle(W/2, OUTFIELD_Y, W*0.86, 160, 0x0a0f1a);   // outfield

        // BOWLER at top, scaled down
        this.bowler = this.add.image(W/2, 140, 'bowler')
          .setScale(0.28)
          .setOrigin(0.5, 1)
          .setDepth(1);

        // BATTER at bottom
        this.player = this.add.image(W/2, H-120, avatarKey)
          .setScale(0.30)
          .setOrigin(0.5, 1)
          .setDepth(2);

        // BAT – anchor near handle so swing looks natural
        this.bat = this.add.image(this.player.x + 38, this.player.y - 8, 'bat')
          .setScale(0.22)
          .setOrigin(0.18, 1)  // near the handle
          .setAngle(0)
          .setDepth(3);

        // wicket zone
        this.wicketZone = new Phaser.Geom.Rectangle(W/2-36, this.player.y-12, 72, 16);
        this.add.rectangle(this.wicketZone.x+36, this.wicketZone.y+8, this.wicketZone.width, this.wicketZone.height, 0x172554, 0.35)
          .setDepth(0);

        // physics group for balls
        this.balls = this.physics.add.group({ allowGravity:false });

        // input
        this.cursors = this.input.keyboard.createCursorKeys();
        this.keys = this.input.keyboard.addKeys({
          A: Phaser.Input.Keyboard.KeyCodes.A,
          D: Phaser.Input.Keyboard.KeyCodes.D,
          SPACE: Phaser.Input.Keyboard.KeyCodes.SPACE
        });

        // touch helpers for mobile
        this.leftHeld = false; this.rightHeld = false;
        this.input.on('pointerdown', p => {
          if (p.x < W/2) this.leftHeld = true; else this.rightHeld = true;
        });
        this.input.on('pointerup',   () => { this.leftHeld = false; this.rightHeld = false; });

        // spawn balls on a timer
        this.timer = this.time.addEvent({ delay: POP.spawnEveryMs, loop: true, callback: () => this.spawnBall() });

        // click/tap anywhere to swing
        this.input.on('pointerup', () => this.trySwing());

        updateHUD();
      }

      spawnBall() {
        // stop if innings over
        if (score.balls >= score.overs*POP.overBalls) return;

        const lineX = Phaser.Math.Between(PITCH_XL+20, PITCH_XR-20);
        const b = this.physics.add.image(W/2, 200, 'ball')
          .setScale(0.18)
          .setDepth(2);
        b.body.setVelocity((lineX - W/2) * 0.35, POP.ballSpeed);
        b.hit = false;

        // When ball passes the batter -> count ball + maybe wicket
        b.update = () => {
          if (!b.hit && b.y > (this.player.y - 16)) {
            // Treat as a “dot ball”
            b.hit = true; score.balls++; updateHUD();
          }
        };

        // cleanup
        this.time.delayedCall(7000, () => { if (b.active) b.destroy(); });
        this.balls.add(b);
      }

      trySwing() {
        const now = this.time.now;
        if (this._swinging && (now - this._lastSwing < POP.batCooldownMs)) return;
        this._swinging = true; this._lastSwing = now;

        // swing animation
        this.tweens.add({
          targets: this.bat,
          angle: -65,
          duration: 140,
          yoyo: true,
          onComplete: () => { this._swinging = false; }
        });

        // check contact a tiny bit into the swing
        this.time.delayedCall(80, () => this.checkContact());
      }

      checkContact() {
        // compute a small contact circle near the bat “blade”
        const rad = Phaser.Math.DegToRad(this.bat.angle - 90);
        const tipX = this.bat.x + Math.cos(rad) * 40;
        const tipY = this.bat.y + Math.sin(rad) * 40;
        const zone = new Phaser.Geom.Circle(tipX, tipY, 36);

        this.balls.children.iterate(obj => {
          const b = obj; if (!b || !b.body || b.hit) return;
          const c = new Phaser.Geom.Circle(b.x, b.y, 18);
          if (Phaser.Geom.Intersects.CircleToCircle(zone, c)) {
            b.hit = true;

            // launch vector
            const perfect = Math.abs(b.x - this.player.x) < 24;
            const power = perfect ? Phaser.Math.Between(480, 560) : Phaser.Math.Between(320, 420);
            const vx = (b.x - this.player.x) * 2 + Phaser.Math.Between(-60, 60);
            b.body.setVelocity(vx, -power);

            // quick & dirty scoring
            score.runs += perfect ? 6 : (power > 460 ? 4 : (power > 360 ? 2 : 1));
            score.balls++; updateHUD();
          }
        });
      }

      update(_, dt) {
        // movement
        const left  = this.cursors.left.isDown || this.keys.A.isDown || this.leftHeld;
        const right = this.cursors.right.isDown || this.keys.D.isDown || this.rightHeld;
        if (left && !right)  this.player.x = Math.max(PITCH_XL, this.player.x - POP.playerSpeed * dt/1000);
        if (right && !left)  this.player.x = Math.min(PITCH_XR, this.player.x + POP.playerSpeed * dt/1000);
        this.bat.x = this.player.x + 38;

        // swing by keyboard
        if (Phaser.Input.Keyboard.JustDown(this.keys.SPACE)) this.trySwing();

        // per-ball update hooks (to tick “dot balls”)
        this.balls.children.iterate(obj => { if (obj && obj.update) obj.update(); });
      }
    }

    const cfg = {
      type: Phaser.AUTO,
      parent: 'game',
      width: W,
      height: H,
      backgroundColor: '#0b1220',
      physics: { default: 'arcade', arcade: { debug: false } },
      scene: [Main]
    };

    // overs selector and new game simply reload the scene for now
    const oversSel = document.getElementById('oversSel');
    const newBtn = document.getElementById('newGameBtn');
    oversSel.onchange = () => {
      score.overs = parseInt(oversSel.value, 10);
      score.runs = 0; score.wkts = 0; score.balls = 0; updateHUD();
      location.reload();
    };
    newBtn.onclick = () => location.reload();

    // Choose Player modal
    const btn = document.getElementById('choose-player-btn');
    if (btn) {
      btn.onclick = async () => {
        const pick = await new Promise(res => {
          const w = document.createElement('div');
          w.style.cssText = 'position:fixed;inset:0;background:#0006;display:flex;align-items:center;justify-content:center;z-index:9999';
          w.innerHTML = `
            <div style="background:#0f172a;border:1px solid #1f2937;border-radius:16px;padding:18px 22px;min-width:280px;text-align:center;color:#e6edf6">
              <h3 style="margin:0 0 10px;font:600 18px system-ui">Choose your player</h3>
              <div style="display:flex;gap:10px;justify-content:center">
                <button id="boy"  style="padding:10px 14px;border-radius:10px;border:1px solid #293241;background:#111827;color:#e6edf6">Boy</button>
                <button id="girl" style="padding:10px 14px;border-radius:10px;border:1px solid #293241;background:#111827;color:#e6edf6">Girl</button>
              </div>
            </div>`;
          document.body.appendChild(w);
          w.querySelector('#boy').onclick  = () => { w.remove(); res('boy'); };
          w.querySelector('#girl').onclick = () => { w.remove(); res('girl'); };
        });
        localStorage.setItem('avatar', pick === 'girl' ? 'girl' : 'boy');
        location.reload();
      };
    }

    new Phaser.Game(cfg);
  })();
  </script>
</body>
</html>
