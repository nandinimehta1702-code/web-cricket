<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cricket Arcade</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">

  <!-- Phaser -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>

  <style>
    html,body{margin:0;height:100%;background:#0b1220;color:#e6edf6;
      font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif}
    .topbar{position:fixed;left:12px;top:8px;display:flex;gap:10px;z-index:10}
    select,button{background:#111827;border:1px solid #293241;border-radius:10px;
      color:#e6edf6;padding:8px 12px}
    #game{display:flex;align-items:center;justify-content:center;height:100%}
    .hud{position:absolute;top:46px;left:18px;font-size:14px}
    .hud b{color:#8ae89a}
    .help{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
      font-size:12px;color:#9aa4b2}
    .btns{position:absolute;bottom:16px;right:16px;display:flex;gap:8px}
    .tbtn{background:#111827;border:1px solid #293241;border-radius:10px;
      padding:10px 14px;color:#e6edf6}
    .panel{position:fixed;left:24px;right:24px;bottom:24px;background:#0f172a;
      border:1px solid #1f2937;border-radius:14px;padding:12px}
    .panel h4{margin:0 0 6px 0}
    #charpick{position:fixed;inset:0;background:rgba(11,18,32,.9);display:none;
      align-items:center;justify-content:center;z-index:50}
    #charpick .card{background:#0f172a;border:1px solid #1f2937;border-radius:16px;
      padding:18px 22px;min-width:280px;text-align:center;color:#e6edf6}
    #charpick .row{display:flex;gap:10px;justify-content:center}
    @media (pointer:fine){ .btns{display:none} }
  </style>
</head>
<body>
  <div class="topbar">
    <select id="overs">
      <option value="1">1 over</option>
      <option value="2" selected>2 overs</option>
      <option value="3">3 overs</option>
      <option value="5">5 overs</option>
    </select>
    <button id="newBtn">New Game</button>
    <button id="chooseBtn">Choose Player</button>
  </div>

  <div id="game"></div>
  <div class="hud" id="hud"></div>
  <div class="help">← / → (or A / D) to move • SPACE to swing</div>
  <div class="btns">
    <button class="tbtn" id="leftBtn">◀</button>
    <button class="tbtn" id="hitBtn">HIT</button>
    <button class="tbtn" id="rightBtn">▶</button>
  </div>

  <div class="panel">
    <h4>Commentary</h4>
    <div id="feed" style="min-height:36px;color:#cbd5e1;font-size:14px">
      No balls bowled yet. Play a shot!
    </div>
  </div>

  <!-- Choose Player modal -->
  <div id="charpick">
    <div class="card">
      <h3 style="margin:0 0 10px;font:600 18px system-ui">Choose your player</h3>
      <div class="row">
        <button id="pickBoy">Boy</button>
        <button id="pickGirl">Girl</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ----- PWA SW register -----
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js', {scope: '/'})
      .catch(console.warn);
  }

  // ----- UI plumbing -----
  const oversSel = document.getElementById('overs');
  const newBtn = document.getElementById('newBtn');
  const chooseBtn = document.getElementById('chooseBtn');
  const pick = document.getElementById('charpick');
  const pickBoy = document.getElementById('pickBoy');
  const pickGirl = document.getElementById('pickGirl');
  const hud = document.getElementById('hud');
  const feed = document.getElementById('feed');

  function showPicker() { pick.style.display = 'flex'; }
  function hidePicker() { pick.style.display = 'none'; }
  if (!localStorage.getItem('avatar')) showPicker();

  pickBoy.onclick = () => { localStorage.setItem('avatar','boy'); hidePicker(); resetGame(); };
  pickGirl.onclick = () => { localStorage.setItem('avatar','girl'); hidePicker(); resetGame(); };
  chooseBtn.onclick = showPicker;

  newBtn.onclick = () => resetGame();

  // ----- Phaser game -----
  const W = 980, H = 560;
  const POP = {
    playerSpeed: 300,
    baseSpawnMs: 1650,
    ballVelY: 260,
    batCooldown: 520,
  };
  let state = {
    runs:0, wkts:0, balls:0, overs:2, overBalls:6,
    gameOver:false, swinging:false, lastSwing:0,
    avatar: localStorage.getItem('avatar') || 'boy'
  };

  const cfg = {
    type: Phaser.AUTO,
    width: W, height: H, backgroundColor: '#0b1220',
    parent: 'game',
    physics:{ default:'arcade', arcade:{ debug:false } },
    scene: { preload, create, update }
  };

  let game, bowler, batter, bat, balls, wicketZone;
  let leftHeld=false, rightHeld=false;

  function preload(){
    // your assets (relative to index.html)
    this.load.image('batterBoy', '/static/game/assets/batter_boy.png');
    this.load.image('batterGirl', '/static/game/assets/batter_girl.png');
    this.load.image('bowler', '/static/game/assets/bowler.png');
    this.load.image('bat', '/static/game/assets/bat.png');
    this.load.image('ball', '/static/game/assets/ball.png');

  }

  function create(){
    // ground/pitch
    this.add.rectangle(W/2,H/2,W,H,0x0f172a);
    this.add.rectangle(W/2,H*0.62,W*0.86,8,0x334155);
    this.add.rectangle(W/2,H*0.78,W*0.86,120,0x0a0f1a);

    // bowler
    bowler = this.add.image(W/2, 120, 'bowler').setScale(0.22).setOrigin(0.5,1);

    // batter + bat
    const avatarKey = (state.avatar === 'girl' ? 'girl' : 'boy');
    batter = this.add.image(W/2, H-110, avatarKey).setScale(0.24).setOrigin(0.5,1);
    bat = this.add.image(batter.x+30, batter.y-24, 'bat').setScale(0.22).setOrigin(0.05,0.9).setAngle(-4);

    // wicket zone (behind batter)
    wicketZone = new Phaser.Geom.Rectangle(W/2-34, H-108, 68, 18);
    this.add.rectangle(wicketZone.x+34,wicketZone.y+9,68,18,0x172554,0.55);

    balls = this.physics.add.group({ allowGravity:false });

    // input
    this.cursors = this.input.keyboard.createCursorKeys();
    this.keys = this.input.keyboard.addKeys({
      A:Phaser.Input.Keyboard.KeyCodes.A,
      D:Phaser.Input.Keyboard.KeyCodes.D,
      SPACE:Phaser.Input.Keyboard.KeyCodes.SPACE
    });

    // touch buttons
    document.getElementById('leftBtn').onpointerdown = ()=> leftHeld=true;
    document.getElementById('leftBtn').onpointerup = document.getElementById('leftBtn').onpointercancel = ()=> leftHeld=false;
    document.getElementById('rightBtn').onpointerdown = ()=> rightHeld=true;
    document.getElementById('rightBtn').onpointerup = document.getElementById('rightBtn').onpointercancel = ()=> rightHeld=false;
    document.getElementById('hitBtn').onclick = ()=> trySwing.call(this);

    this.time.addEvent({ delay: POP.baseSpawnMs, loop:true, callback: ()=> spawnBall.call(this) });

    updateHUD();
    speak("New game. Good luck!");
  }

  function spawnBall(){
    if(state.gameOver) return;
    const lineX = Phaser.Math.Between(140, W-140);
    const ball = this.physics.add.image(W/2, 160, 'ball').setScale(0.14);
    ball.body.allowGravity=false;
    ball.setVelocity((lineX - W/2)*0.35, POP.ballVelY);
    ball.hit=false;
    balls.add(ball);
    this.time.delayedCall(6000, ()=> ball.destroy());
  }

  function trySwing(){
    if(state.gameOver) return;
    const now = this.time.now;
    if(state.swinging) return;
    if(now - state.lastSwing < POP.batCooldown) return;

    state.swinging=true; state.lastSwing=now;

    this.tweens.add({ targets:bat, angle:-70, duration:140, yoyo:true,
      onComplete:()=>{ state.swinging=false; } });

    this.time.delayedCall(80, ()=> checkContact.call(this));
  }

  function checkContact(){
    const p = new Phaser.Math.Vector2(bat.x, bat.y);
    const tip = Phaser.Math.RotateAround(p.clone(), bat.x, bat.y, Phaser.Math.DegToRad(bat.angle-88));
    const zone = new Phaser.Geom.Circle(tip.x, tip.y, 32);

    balls.children.each((b)=>{
      if(!b || !b.body || b.hit) return;
      const c = new Phaser.Geom.Circle(b.x,b.y,16);
      if(Phaser.Geom.Intersects.CircleToCircle(zone,c)){
        b.hit=true;
        const perfect = Math.abs(b.x - batter.x) < 22;
        const power = perfect ? Phaser.Math.Between(480,560) : Phaser.Math.Between(320,420);
        const vx = (b.x - batter.x)*2 + Phaser.Math.Between(-60,60);
        b.setVelocity(vx, -power);

        const speed = Math.hypot(vx,power);
        let runs = 1;
        if(speed > 540 || perfect) runs=6; else if(speed>480) runs=4; else if(speed>360) runs=2;
        addRuns(runs);
      }
    });
  }

  function addRuns(r){
    state.runs += r;
    speak(r>=6 ? "SIX!" : r>=4 ? "FOUR!" : r===3 ? "Three!" : r===2 ? "Two runs." : "Single.");
    ballDone();
  }

  function wicket(){
    state.wkts++;
    speak("Bowled!");
    ballDone();
    if(state.wkts>=10) endInnings();
  }

  function ballDone(){
    state.balls++;
    updateHUD();
    if(state.balls >= state.overs*state.overBalls) endInnings();
  }

  function endInnings(){
    if(state.gameOver) return;
    state.gameOver = true;
    speak(`Innings complete: ${state.runs}/${state.wkts}`);
  }

  function speak(t){
    feed.textContent = t;
  }

  function updateHUD(){
    const o = Math.floor(state.balls/6), b = state.balls%6;
    const left = state.overs*6 - state.balls;
    hud.innerHTML = `<b>Score:</b> ${state.runs}/${state.wkts} • <b>Overs:</b> ${o}.${b} • <b>Balls left:</b> ${left}`;
  }

  function resetGame(){
    state = {
      runs:0, wkts:0, balls:0, overs: parseInt(oversSel.value,10) || 2,
      overBalls:6, gameOver:false, swinging:false, lastSwing:0,
      avatar: localStorage.getItem('avatar') || 'boy'
    };
    if(game) { game.destroy(true); }
    game = new Phaser.Game(cfg);
  }

  function update(_, dt){
    const left = this.cursors.left.isDown || this.keys.A.isDown || leftHeld;
    const right = this.cursors.right.isDown || this.keys.D.isDown || rightHeld;
    if(left && !right) batter.x = Math.max(120, batter.x - POP.playerSpeed*dt/1000);
    else if(right && !left) batter.x = Math.min(W-120, batter.x + POP.playerSpeed*dt/1000);
    bat.x = batter.x + 30;

    if(Phaser.Input.Keyboard.JustDown(this.keys.SPACE)) trySwing.call(this);

    balls.children.each((b)=>{
      if(!b || !b.body || b.hit) {
        if(b && b.y > H+18) { b.destroy(); ballDone(); }
        return;
      }
      if(b.y > wicketZone.y && b.x > wicketZone.x && b.x < wicketZone.x + wicketZone.width){
        b.hit=true; b.destroy(); wicket();
      }
    });
  }

  // start
  resetGame();
})();
</script>
</body>
</html>
